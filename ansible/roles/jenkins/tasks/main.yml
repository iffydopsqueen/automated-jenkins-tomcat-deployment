---

# Install and configure Jenkins
- name: Update system packages
  apt:
    update_cache: yes
    upgrade: dist
  tags:
    - system-update

- name: Install system packages
  apt:
    name: "{{ system_packages }}"
    state: present
  tags:
    - dependencies
    - java
    - maven

- name: Verify Java installation
  command: java -version
  register: java_version_check
  changed_when: false
  tags:
    - java

- name: Set JAVA_HOME environment variable
  lineinfile:
    path: /etc/profile.d/java.sh
    line: "export JAVA_HOME={{ java_home }}"
    create: yes
    state: present
  tags:
    - java

- name: Add Jenkins apt keyring
  get_url:
    url: https://pkg.jenkins.io/debian-stable/jenkins.io-2026.key
    dest: /usr/share/keyrings/jenkins-keyring.asc
    mode: "0644"
    force: yes
  tags:
    - jenkins-repo

- name: Ensure Jenkins keyring has correct permissions
  file:
    path: /usr/share/keyrings/jenkins-keyring.asc
    mode: "0644"
  tags:
    - jenkins-repo

# Troubleshoot existing Jenkins repo entries
- name: Remove Jenkins repo entry from sources.list
  lineinfile:
    path: /etc/apt/sources.list
    regexp: "^deb(-src)?\\s+.*https://pkg.jenkins.io/debian-stable\\s+binary/.*$"
    state: absent
  tags:
    - jenkins-repo

- name: Find apt source list files
  find:
    paths: /etc/apt/sources.list.d
    patterns:
      - "*.list"
      - "*.sources"
  register: apt_source_lists
  tags:
    - jenkins-repo

- name: Read apt source list files
  slurp:
    src: "{{ item.path }}"
  loop: "{{ apt_source_lists.files }}"
  register: apt_source_list_contents
  tags:
    - jenkins-repo

- name: Remove Jenkins repo source files
  file:
    path: "{{ item.item.path }}"
    state: absent
  when: "'pkg.jenkins.io' in (item.content | b64decode)"
  loop: "{{ apt_source_list_contents.results }}"
  tags:
    - jenkins-repo

- name: Add Jenkins apt repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/"
    state: present
    filename: jenkins
  tags:
    - jenkins-repo

- name: Update apt cache after adding Jenkins repo
  apt:
    update_cache: yes
  tags:
    - jenkins-repo

- name: Install Jenkins
  apt:
    name: jenkins
    state: present
  tags:
    - jenkins-install

- name: Start Jenkins service
  systemd:
    name: jenkins
    state: started
    enabled: yes
    daemon_reload: yes
  tags:
    - jenkins-service

- name: Wait for Jenkins to start
  wait_for:
    port: "{{ jenkins_port }}"
    delay: 10
    timeout: 300
  tags:
    - jenkins-service

- name: Get initial Jenkins admin password
  command: cat /var/lib/jenkins/secrets/initialAdminPassword
  register: jenkins_admin_password
  changed_when: false
  tags:
    - jenkins-config
